package com.ff0000.utils.zencode {    import flash.display.MovieClip;	import flash.events.MouseEvent;	    import flash.desktop.NativeProcess;    import flash.desktop.NativeProcessStartupInfo;    import flash.events.Event;    import flash.events.ProgressEvent;    import flash.events.IOErrorEvent;    import flash.events.NativeProcessExitEvent;    import flash.filesystem.File;	import com.greensock.TweenLite;	import flash.net.URLRequest;	import fl.video.MetadataEvent;	import flash.events.KeyboardEvent;	import fl.video.FLVPlayback;	import flash.net.URLLoader;		public class ZEncode extends MovieClip{				// encoder settings xml location		private const ENCODER_SETTINGS_XML:String = 'http://client-projects.com/_ads_dev/zencode/zencode_settings.xml';		// process utilities		private var confirmProcess:NativeProcess;		private var installProcess:NativeProcess;		private var encodeProcess:NativeProcess;				private var encodeSettings:Object;				// on stage		public var reviewContainer:MovieClip;		public var progressIndication:MovieClip;		public var inputVideo:MovieClip;		public var output:MovieClip;				// review		public var flvPlayback:FLVPlayback;				// constructor code		public function ZEncode() {			addEventListener( Event.ADDED_TO_STAGE, handleAddedToStage );			progressIndication.alpha = 0;			progressIndication.visible = false;						inputVideo.alpha = 0;			inputVideo.visible = false;						reviewContainer.alpha = 0;			reviewContainer.visible = false;		}				// handle added to stage		private function handleAddedToStage( $_e:Event ):void {			removeEventListener( Event.ADDED_TO_STAGE, handleAddedToStage );            if( NativeProcess.isSupported ) {                confirmFFMPEGInstall();            }            else {                output.tf.text = "NativeProcess not supported.";            }		}								// confirm ffmpeg install		private function confirmFFMPEGInstall():void {			trace( this, 'confirmFFMPEGInstall()' );			var nativeProcessStartupInfo:NativeProcessStartupInfo = new NativeProcessStartupInfo();			var file:File = File.applicationDirectory.resolvePath( '/usr/bin/python' );			nativeProcessStartupInfo.executable = file;			var processArgs:Vector.<String> = new Vector.<String>();			processArgs[0] = File.applicationDirectory.resolvePath( 'confirm_ffmpeg.py' ).nativePath;			nativeProcessStartupInfo.arguments = processArgs;						confirmProcess = new NativeProcess();			confirmProcess.addEventListener( ProgressEvent.STANDARD_OUTPUT_DATA, handleConfirmOutput );			confirmProcess.start( nativeProcessStartupInfo );		}		private function handleConfirmOutput( $_e:ProgressEvent ):void {			var _result:String = String( confirmProcess.standardOutput.readUTFBytes( confirmProcess.standardOutput.bytesAvailable ));			//trace( 'STDOUT ' + confirmProcess.standardOutput.readUTFBytes( confirmProcess.standardOutput.bytesAvailable ) );			var _status:Array = _result.match( /No\ssuch\sfile\sor\sdirectory/ );			trace( 'CONFIRM FFMPEG RESULT: '+_status );			confirmProcess.exit();			if( _status != null )				//doInstallFFMPEG();				output.tf.htmlText = '<font color="#990000">Please have Greg run the FFMPEG install script.</font>';			else {				getEncoderSettings();			}		}		// get encoder settings		private function getEncoderSettings():void {			trace( this, 'getEncoderSettings()' );			var _urlRequest:URLRequest = new URLRequest( ENCODER_SETTINGS_XML );			var _urlLoader:URLLoader = new URLLoader();			_urlLoader.addEventListener( Event.COMPLETE, handleEncoderSettings );			_urlLoader.load( _urlRequest );		}		private function handleEncoderSettings( $_e:Event ):void {			encodeSettings = {};			encodeSettings.settings = '';			for each( var _setting:XML in XML( $_e.target.data ).settings.setting ) {				encodeSettings.settings += '-' + _setting.control + ' ' + _setting.value + ' ';			}			trace( ' settings: '+encodeSettings.settings );			initUI();					}		// init UI		private function initUI():void {			trace( this, 'initUI()' );			inputVideo.path.tabEnabled = false;			inputVideo.browse.tabIndex = 1;			inputVideo.w.tabIndex = 2;			inputVideo.h.tabIndex = 3;			inputVideo.bitrate.tabIndex = 4;			inputVideo.audio.tabIndex = 5;			inputVideo.encode.tabIndex = 6;			output.tf.tabEnabled = false;			output.tf.focusRect = false;						inputVideo.visible = true;			TweenLite.to( inputVideo, 0.3, { alpha: 1 });			inputVideo.path.addEventListener( MouseEvent.CLICK, handleBrowseFileRequest );			inputVideo.browse.addEventListener( MouseEvent.CLICK, handleBrowseFileRequest );			inputVideo.browse.addEventListener( KeyboardEvent.KEY_DOWN, handleBrowseKeydown );			inputVideo.audio.addEventListener( KeyboardEvent.KEY_DOWN, handleAudioKeydown );			inputVideo.encode.addEventListener( MouseEvent.CLICK, handleEncodeRequest );			inputVideo.encode.addEventListener( KeyboardEvent.KEY_DOWN, handleEncodeKeydown );		}				// handle browse file request		private function handleBrowseFileRequest( $_e:MouseEvent = null ):void {			trace( 'handle browse' );			encodeSettings.file = new File();			encodeSettings.file.addEventListener( Event.SELECT, handleFileSelect );			encodeSettings.file.browse();		}		// handle browse key down		private function handleBrowseKeydown( $_e:KeyboardEvent ):void {			//trace( $_e.charCode );			if( $_e.charCode == 13 ) {				handleBrowseFileRequest();			}		}		private function handleFileSelect( $_e:Event ):void {			inputVideo.path.text = encodeSettings.file.name;			encodeSettings.path = encodeSettings.file.nativePath.substr( 0, encodeSettings.file.nativePath.length - encodeSettings.file.name.length );			encodeSettings.escapedFilename = encodeSettings.file.name.replace( /\s/g, '\\ ' );						encodeSettings.resultFilename = encodeSettings.file.name.replace( /\..+$/, '.mp4' );			encodeSettings.escapedResultFilename = encodeSettings.resultFilename.replace( /\s/g, '\\ ' );						encodeSettings.escapedPath = encodeSettings.path.replace( /\s/g, '\\ ' );		}				// handle audio key down		private function handleAudioKeydown( $_e:KeyboardEvent ):void {			if( $_e.charCode == 13 ) {				if( inputVideo.audio.selected )					inputVideo.audio.selected = false;				else inputVideo.audio.selected = true;			}		}		// handle key down		private function handleEncodeKeydown( $_e:KeyboardEvent ):void {			//trace( $_e.charCode );			if( $_e.charCode == 13 ) {				handleEncodeRequest();			}		}		// handle encode request		private function handleEncodeRequest( $_e:MouseEvent = null ):void {			trace( this, 'handleEncodeRequest()' );			// validate			var _errorResult:String = '';			if( encodeSettings.file == null ) 				_errorResult += 'Please select a file<br />';			if( inputVideo.w.text == '' || inputVideo.h.text == '' ) 				_errorResult += 'Please specify a width/height.<br />';			if( inputVideo.bitrate.text == '' ) 				_errorResult += 'Please specify a target bitrate.<br />';			encodeSettings.bitrate = parseInt( inputVideo.bitrate.text );			if( encodeSettings.bitrate < 50 ) 				_errorResult += 'Please select a bitrate greater-than or equal to 50.<br />';			if( _errorResult != '' ) {				output.tf.htmlText = '<font color="#990000;">' + _errorResult + '</font>';				return;			}						encodeSettings.width = int( inputVideo.w.text );			encodeSettings.height = int( inputVideo.h.text );			if( encodeSettings.width % 2 != 0 ) 				encodeSettings.width += 1;			if( encodeSettings.height % 2 != 0 ) 				encodeSettings.height += 1;			encodeSettings.size = encodeSettings.width + 'x' + encodeSettings.height;						encodeSettings.audio = inputVideo.audio.selected;			output.tf.text = '';			progressIndication.visible = true;			progressIndication.tf.text = 'ENCODING';			TweenLite.to( progressIndication, 0.3, { alpha: 1 });			var _nativeProcessStartupInfo:NativeProcessStartupInfo = new NativeProcessStartupInfo();			var _file:File = File.applicationDirectory.resolvePath( '/usr/bin/python' );			_nativeProcessStartupInfo.executable = _file;						var _encodeAudio:String =  !encodeSettings.audio ? '-an' : '';			var _ffmpegSettings:String = '"/usr/local/bin/ffmpeg -i '+				encodeSettings.escapedPath + encodeSettings.escapedFilename +				' -y ' + _encodeAudio + ' -s ' + encodeSettings.size +				' -b ' + encodeSettings.bitrate + 'k ' + encodeSettings.settings +				encodeSettings.escapedPath + encodeSettings.escapedResultFilename + '"';			var _processArgs:Vector.<String> = new Vector.<String>();			_processArgs[0] = File.applicationDirectory.resolvePath( 'encode_ffmpeg.py' ).nativePath;			_processArgs[1] = '-f'			_processArgs[2] = _ffmpegSettings;			_nativeProcessStartupInfo.arguments = _processArgs;						encodeProcess = new NativeProcess();			encodeProcess.addEventListener( ProgressEvent.STANDARD_OUTPUT_DATA, handleEncodeOutput );			encodeProcess.addEventListener( NativeProcessExitEvent.EXIT, handleEncodeComplete );			encodeProcess.start( _nativeProcessStartupInfo );		}		// handle encode output		private function handleEncodeOutput( $_e:ProgressEvent ):void {			var _result:String = String( encodeProcess.standardOutput.readUTFBytes( encodeProcess.standardOutput.bytesAvailable ));			output.tf.text = output.tf.text + '\n' + _result;		}		// handle encode complete		private function handleEncodeComplete( $_e:NativeProcessExitEvent ):void {			encodeProcess.removeEventListener( ProgressEvent.STANDARD_OUTPUT_DATA, handleEncodeOutput );			encodeProcess.removeEventListener( NativeProcessExitEvent.EXIT, handleEncodeComplete );			output.tf.text = output.tf.text + '\nRESULT FILE: ' + encodeSettings.path + encodeSettings.resultFilename;			openPreviewWith( encodeSettings.path + encodeSettings.resultFilename );		}				// open preview with		private function openPreviewWith( $_target:String ):void {			TweenLite.to( progressIndication, 0.3, { alpha: 0, onComplete: function() { progressIndication.visible = false; }});			output.tf.text = output.tf.text + '\nEncode complete!!';			trace( $_target );			var _resultFile:File = File.applicationDirectory.resolvePath( $_target );			reviewContainer.tf.htmlText = _resultFile.nativePath + '<br/>Result ksize: <font color="#990000;">' + Math.round( _resultFile.size/1000 ) + 'k</font>';						flvPlayback = new FLVPlayback();			flvPlayback.addEventListener( MetadataEvent.METADATA_RECEIVED, handleMetadata );			flvPlayback.source = 'file://' + _resultFile.nativePath;			reviewContainer.flvContainer.addChild( flvPlayback );			reviewContainer.closeButton.addEventListener( MouseEvent.CLICK, closePreview );			reviewContainer.closeButton.addEventListener( KeyboardEvent.KEY_DOWN, handleClosePreviewKeydown );						reviewContainer.visible = true;			TweenLite.to( reviewContainer, 0.3, { alpha: 1 });		}		private function handleMetadata( $_e:MetadataEvent ):void {			flvPlayback.width = $_e.info.width;			flvPlayback.height = $_e.info.height;			flvPlayback.x = Math.round(( 900 - $_e.info.width ) / 2 );			flvPlayback.y = 50 + Math.round(( 600 - $_e.info.height ) / 2 );		}				// handle close preview key down		private function handleClosePreviewKeydown( $_e:KeyboardEvent ):void {			//trace( $_e.charCode );			if( $_e.charCode == 13 ) {				closePreview();			}		}		// close preview		private function closePreview( $_e:MouseEvent=null ):void {			flvPlayback.removeEventListener( MetadataEvent.METADATA_RECEIVED, handleMetadata );			flvPlayback.stop();			while( reviewContainer.flvContainer.numChildren > 0 )			 	reviewContainer.flvContainer.removeChildAt( 0 );			reviewContainer.closeButton.removeEventListener( MouseEvent.CLICK,closePreview );			TweenLite.to( reviewContainer, 0.3, { alpha: 0, onComplete: function() { reviewContainer.visible = false; }});		}								// -- install ffmpeg 		private function doInstallFFMPEG():void {			trace( this, 'doInstallFFMPEG()' );			installFFMPEG();		}				/* confirm ffmpeg install		private function confirmFFMPEGInstall():void {			trace( this, 'confirmFFMPEGInstall()' );			var nativeProcessStartupInfo:NativeProcessStartupInfo = new NativeProcessStartupInfo();			var file:File = File.applicationDirectory.resolvePath( '/usr/bin/python' );			nativeProcessStartupInfo.executable = file;			var processArgs:Vector.<String> = new Vector.<String>();			processArgs[0] = File.applicationDirectory.resolvePath( 'confirm_ffmpeg.py' ).nativePath;			nativeProcessStartupInfo.arguments = processArgs;						confirmProcess = new NativeProcess();			confirmProcess.addEventListener( ProgressEvent.STANDARD_OUTPUT_DATA, handleConfirmOutput );			//confirmProcess.addEventListener( ProgressEvent.STANDARD_OUTPUT_DATA, handleConfirmError );			//confirmProcess.addEventListener( NativeProcessExitEvent.EXIT, handleConfirmComplete );			confirmProcess.start( nativeProcessStartupInfo );		}		private function handleConfirmOutput( $_e:ProgressEvent ):void {			var _result:String = String( confirmProcess.standardOutput.readUTFBytes( confirmProcess.standardOutput.bytesAvailable ));			//trace( 'STDOUT ' + confirmProcess.standardOutput.readUTFBytes( confirmProcess.standardOutput.bytesAvailable ) );			var _status:Array = _result.match( /No\ssuch\sfile\sor\sdirectory/ );			trace( 'CONFIRM FFMPEG RESULT: '+_status );			confirmProcess.exit();			if( _status != null )				doInstallFFMPEG();				//output.tf.htmlText = '<font color="#990000">Please have Greg run the FFMPEG install script.</font>';			else initUI();		}		*/		private function installFFMPEG():void {			output.tf.text = '';			progressIndication.visible = true;			progressIndication.tf.text = 'INSTALLING FFMPEG';			TweenLite.to( progressIndication, 0.3, { alpha: 1 });						var nativeProcessStartupInfo:NativeProcessStartupInfo = new NativeProcessStartupInfo();			var file:File = File.applicationDirectory.resolvePath( '/usr/bin/python' );			nativeProcessStartupInfo.executable = file;						var processArgs:Vector.<String> = new Vector.<String>();			processArgs[0] = File.applicationDirectory.resolvePath( 'install_ffmpeg.py' ).nativePath;			nativeProcessStartupInfo.arguments = processArgs;						installProcess = new NativeProcess();			installProcess.addEventListener( ProgressEvent.STANDARD_OUTPUT_DATA, onOutputData );			installProcess.addEventListener( NativeProcessExitEvent.EXIT, handleProcessComplete );			installProcess.start( nativeProcessStartupInfo );		}		public function onOutputData(event:ProgressEvent):void {			var _output:String = String( installProcess.standardOutput.readUTFBytes( installProcess.standardOutput.bytesAvailable ));			//output.tf.text += _output;			var _status:Array = _output.match( /<AS3>.*<\/AS3>/ );			if( _status != null )				output.tf.text += '\n' + _status[0].substr( 5, _status[0].length-10 );		}		private function handleProcessComplete( $_e:NativeProcessExitEvent ):void {			trace( " - PROCESS COMPLETE: ", $_e.exitCode );			installProcess.removeEventListener( ProgressEvent.STANDARD_OUTPUT_DATA, onOutputData );			installProcess.removeEventListener( NativeProcessExitEvent.EXIT, handleProcessComplete );			TweenLite.to( progressIndication, 0.3, { alpha: 0, onComplete: function() { progressIndication.visible = false; }});			initUI();		}										/* -- UTILITIES --------------------------------------------------		 *		 *		 */		private function parseStdoutFor( $_string:String, $_tag ):String {			var _as3Messages:Array = $_string.match( /<AS3>.+<\/AS3>/g );			for( var _i:int = 0; _i < _as3Messages.length; _i++ ) {				_as3Messages[_i] = new XML( _as3Messages[_i] );				if( _as3Messages[_i][$_tag] != null ) {					return _as3Messages[_i][$_tag];				}			}			return null;		}	}	}